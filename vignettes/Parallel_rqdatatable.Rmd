---
title: "Parallel rqdatatable"
author: "John Mount"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Parallel rqdatatable}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

One can try to execute `relop` trees in parallel. However, in unless the pipeline is very expensive
the overhead of partitioning and distributing the work will by far overwhelm any parallel speedup.
Also `data.table` itself already seems to exploit some thread-level parallelism (notice user time > elapsed time).

```{r}
library("rqdatatable")
cl <- parallel::makeCluster(2)
#parallel::clusterEvalQ(cl, library("rquery"))
#parallel::clusterEvalQ(cl, library("rqdatatable"))

set.seed(2362)
mk_example <- function(nkey, nrow, nrep = 5) {
  keys <- paste0("key_", seq_len(nkey))
  nrep <- 5
  key_table <- data.frame(
    key = rep(keys, 5),
    data = runif(nkey),
    stringsAsFactors = FALSE)
  instance_table <- data.frame(
    id = seq_len(nrow),
    key = sample(keys, nrow, replace = TRUE),
    group = sample(letters[1:9], nrow, replace = TRUE),
    info = runif(nrow),
    stringsAsFactors = FALSE)
  list(key_table = key_table,
       instance_table = instance_table)
}

dlist <- mk_example(20, 100)
data <- dlist$instance_table
annotation <- dlist$key_table


# possible data lookup: find rows that
# have lookup data <= info
optree <- local_td(data) %.>%
  natural_join(., local_td(annotation), jointype = "INNER", by = "key") %.>%
  select_rows_nse(., data <= info) %.>%
  pick_top_k(., 
             k = 1,
             partitionby = "id",
             orderby = "data",
             reverse = "data",
             keep_order_column = FALSE) %.>%
  orderby(., "id")
cat(format(optree))

                   

res1 <- ex_data_table(optree)
head(res1)
nrow(res1)

res2 <- ex_data_table_parallel(optree, "group", cl)
head(res2)
nrow(res2)

dlist <- mk_example(10000, 10000, 10)
data <- dlist$instance_table
annotation <- dlist$key_table

system.time(ex_data_table(optree))

system.time(ex_data_table_parallel(optree, "group", cl))


parallel::stopCluster(cl)
rm(list = "cl")
```
