---
title: "Parallel rqdatatable"
author: "John Mount"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Parallel rqdatatable}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

One can try to execute `relop` trees in parallel. However, in unless the pipeline is very expensive
the overhead of partitioning and distributing the work will by far overwhelm any parallel speedup.
Also `data.table` itself already seems to exploit some thread-level parallelism (notice user time > elapsed time).

```{r}
library("rqdatatable")
cl <- parallel::makeCluster(2)
#parallel::clusterEvalQ(cl, library("rquery"))
#parallel::clusterEvalQ(cl, library("rqdatatable"))

set.seed(2362)
mk_example <- function(nrow, ncol) {
  lst <- lapply(seq_len(ncol),
         function(i) {
           ci <- runif(nrow)
           names(ci) <- paste0("v_", i)
           ci
         })
  names(lst) <- paste0("v_", seq_len(ncol))
  f <- as.data.frame(lst)
  f$g <- sample.int(100, nrow, replace = TRUE)
  f$partition <- f$g %% 5 
  f
}

ncol = 5
dL <- mk_example(200, ncol)

# build a ridiculous pipeline
optree <- local_td(dL)
nsteps <- 10
for(i in seq_len(nsteps)) {
  rcol <- paste0("nc_", i)
  scol <- paste0("v_", sample.int(ncol, 1))
  ocol <- paste0("v_", sample.int(ncol, 1))
  optree <- optree %.>%
    extend_se(., 
              rcol %:=% paste0("cumsum(dnorm(", scol, "))"),
              partitionby = "g", 
              orderby = c(ocol, scol)) %.>%
    extend_se(., 
              rcol %:=% paste0("cumsum(dnorm(", scol, "))"),
              partitionby = "partition", 
              orderby = c(ocol, scol),
              reverse = c(ocol, scol)) 
  if(i>1) {
    pcol <- paste0("nc_", i-1)
    optree <- optree %.>%
    extend_se(., rcol %:=% paste(rcol, "+", pcol))
  }
}
optree <- optree %.>%
  select_columns(., paste0("nc_", nsteps)) %.>%
  orderby(., paste0("nc_", nsteps))
#cat(format(optree))
                   

res1 <- ex_data_table(optree)
head(res1)

res2 <- ex_data_table_parallel(optree, "partition", cl)
head(res2)

dL <- mk_example(1000000, ncol)

system.time(ex_data_table(optree))

system.time(ex_data_table_parallel(optree, "partition", cl))


parallel::stopCluster(cl)
rm(list = "cl")
```
